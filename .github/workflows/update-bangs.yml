name: Daily Update of Bangs and Packages

on:
  schedule:
    - cron: "0 21 * * *"   # 08:00 AEDT daily
  workflow_dispatch:

jobs:
  update-bangs:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v6

      - name: Set up Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Update dependencies
        run: bun update

      - name: Fetch DDG bangs
        run: |
          curl -s https://duckduckgo.com/bang.js > ddg_bangs.json

      - name: Fetch Kagi bangs
        run: |
          curl -s https://raw.githubusercontent.com/kagisearch/bangs/refs/heads/main/data/bangs.json > kagi_bangs.json

      - name: Merge bangs into src/bangs.ts
        run: bun run merge-bangs.js

      - name: Clean up fetched bang files
        run: rm -f ddg_bangs.json kagi_bangs.json

      - name: Open PR
        uses: peter-evans/create-pull-request@v7
        with:
          commit-message: "Daily Update of Bangs and Packages"
          branch: update-bangs
          title: "Daily Update of Bangs and Packages"
          body: "Automated update of DuckDuckGo and Kagi bangs and bun packages."
          base: main
          add-paths: |
            src/bang.ts
            package.json
            bun.lock
