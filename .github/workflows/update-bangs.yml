name: Update Bangs and Packages

on:
  schedule:
    - cron: "0 21 * * *"   # 08:00 AEDT daily
  workflow_dispatch:

jobs:
  update-bangs:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v6

      - name: Set up Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Update dependencies
        run: bun update

      - name: Fetch DDG bangs
        run: |
          curl -s https://duckduckgo.com/bang.js > ddg_bangs.json

      - name: Fetch Kagi bangs
        run: |
          curl -s https://raw.githubusercontent.com/kagisearch/bangs/refs/heads/main/data/bangs.json > kagi_bangs.json

      - name: Merge bangs into src/bangs.ts
        run: bun run merge-bangs.js

      - name: Clean up fetched bang files
        run: rm -f ddg_bangs.json kagi_bangs.json

      - name: Configure git identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create new branch and commit changes
        id: commit
        run: |
          BRANCH="update-bangs-$(date +%Y%m%d)"
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT

          git checkout -b "$BRANCH"
          git add src/bang.ts

          if git diff --cached --quiet; then
            echo "No changes detected."
            exit 0
          fi

          git commit -m "Daily Bang and Package Update"
          git push origin "$BRANCH"

      - name: Open PR
        uses: peter-evans/create-pull-request@v7
        with:
          branch: ${{ steps.commit.outputs.branch }}
          title: "Daily Bang and Package Update"
          body: "Automated update of DuckDuckGo and Kagi bangs and bun packages."
          base: main
