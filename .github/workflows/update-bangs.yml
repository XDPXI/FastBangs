name: Update Bangs

on:
  schedule:
    - cron: "0 21 * * *"   # 08:00 AEDT daily
  workflow_dispatch:

jobs:
  update-bangs:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v6

      - name: Set up Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies (with Bun)
        run: bun install

      - name: Fetch DDG bangs
        run: |
          curl -s https://duckduckgo.com/bang.js > ddg_bangs.json

      - name: Fetch Kagi bangs
        run: |
          curl -s https://kagi.com/api/v0/bangs > kagi_bangs.json

      - name: Merge bangs into src/bangs.ts
        run: bun run scripts/merge-bangs.js

      - name: Create new branch and commit changes
        id: commit
        run: |
          BRANCH="update-bangs-$(date +%Y%m%d)"
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT

          git checkout -b "$BRANCH"
          git add src/bangs.ts

          if git diff --cached --quiet; then
            echo "No changes detected."
            exit 0
          fi

          git commit -m "Daily bang update"
          git push origin "$BRANCH"

      - name: Open PR
        uses: peter-evans/create-pull-request@v7
        with:
          branch: ${{ steps.commit.outputs.branch }}
          title: "Daily Bangs Update"
          body: "Automated merge of DDG + Kagi bangs into src/bangs.ts"
          base: main